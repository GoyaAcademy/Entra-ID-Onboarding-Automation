{
  "name": "Entra ID Onboarding Assistant",
  "nodes": [
    {
      "parameters": {
        "path": "entra-onboarding-chat",
        "options": {}
      },
      "id": "WebhookTrigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "url": "https://raw.githubusercontent.com/GoyaAcademy/Entra-ID-Onboarding-Automation/main/questionnaires/questionnaire-sso-initiation-entra.json",
        "responseFormat": "json"
      },
      "id": "FetchQuestionnaire",
      "name": "Fetch Questionnaire JSON",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [400, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT current_question, app_id FROM entra_conversation_state WHERE user_id = {{$json[\"userId\"]}}"
      },
      "id": "GetConversationState",
      "name": "Get Conversation State",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "credentials": {
        "postgres": "CRED.postgres"
      },
      "position": [600, 200]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "entra_conversation_answers",
        "columns": ["user_id", "question_id", "answer"],
        "values": "={{[$json[\"userId\"], $json[\"questionId\"], $json[\"message\"]]}}"
      },
      "id": "SaveAnswer",
      "name": "Save Answer",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "credentials": {
        "postgres": "CRED.postgres"
      },
      "position": [600, 400]
    },
    {
      "parameters": {
        "url": "https://raw.githubusercontent.com/GoyaAcademy/Entra-ID-Onboarding-Automation/main/templates/entra_app_onboarding.yaml",
        "responseFormat": "string"
      },
      "id": "FetchTemplate",
      "name": "Fetch YAML Template",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [800, 200]
    },
    {
      "parameters": {
        "functionCode": "const yaml = $json[\"body\"];\n// Replace placeholders with answers and metadata (pseudo logic)\nlet filledYaml = yaml\n  .replace('{{app_id}}', $json.app_id)\n  .replace('{{app_name}}', $json.app_name);\n// Add more replacements as needed\nreturn [{ yaml: filledYaml }];"
      },
      "id": "FillTemplate",
      "name": "Fill Template",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1000, 200]
    },
    {
      "parameters": {
        "url": "https://api.github.com/repos/GoyaAcademy/Entra-ID-Onboarding-Automation/contents/templates/app-{{$json.app_id}}.yaml",
        "method": "PUT",
        "authentication": "predefinedCredentialType",
        "sendBody": true,
        "jsonBody": true,
        "bodyParametersJson": "={\n  \"message\": \"feat: add onboarding config for app-\" + $json.app_id,\n  \"content\": Buffer.from($json.yaml).toString(\"base64\"),\n  \"branch\": \"onboard-app-\" + $json.app_id\n}",
        "options": {}
      },
      "id": "CreatePR",
      "name": "Create GitHub PR",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "credentials": {
        "githubApi": "CRED.github"
      },
      "position": [1200, 200]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "entra_workflow_logs",
        "columns": ["event", "workflow", "node", "status", "timestamp", "level"],
        "values": "={{['app_onboarding','entra-id-onboarding','Create GitHub PR','SUCCESS', $now, 'INFO']}}"
      },
      "id": "LogEvent",
      "name": "Log Event",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "credentials": {
        "postgres": "CRED.postgres"
      },
      "position": [1400, 200]
    },
    {
      "parameters": {},
      "id": "ErrorTrigger",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [200, 600]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "entra_workflow_logs",
        "columns": ["event", "workflow", "node", "status", "error", "timestamp", "level"],
        "values": "={{['app_onboarding','entra-id-onboarding','ErrorTrigger','FAILURE', $json.error.message, $now, 'ERROR']}}"
      },
      "id": "LogError",
      "name": "Log Error",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "credentials": {
        "postgres": "CRED.postgres"
      },
      "position": [400, 600]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "FetchQuestionnaire",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FetchQuestionnaire": {
      "main": [
        [
          {
            "node": "GetConversationState",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetConversationState": {
      "main": [
        [
          {
            "node": "SaveAnswer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SaveAnswer": {
      "main": [
        [
          {
            "node": "FetchTemplate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FetchTemplate": {
      "main": [
        [
          {
            "node": "FillTemplate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FillTemplate": {
      "main": [
        [
          {
            "node": "CreatePR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CreatePR": {
      "main": [
        [
          {
            "node": "LogEvent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ErrorTrigger": {
      "main": [
        [
          {
            "node": "LogError",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {},
  "version": 1,
  "metadata": {
    "version": "1.0.0",
    "tags": ["semver:1.0.0","entra-id","onboarding","demo"],
    "author": "n8n Architect Pro",
    "createdAt": "2025-09-15T00:00:00Z",
    "changelog": [
      "feat: initial workflow for Entra ID onboarding via questionnaire (multi-step)"
    ]
  },
  "id": "entra-id-onboarding"
}
