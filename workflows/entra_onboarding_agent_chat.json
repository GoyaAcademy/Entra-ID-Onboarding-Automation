{
  "name": "entra_onboarding_agent_chat",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        -960,
        0
      ],
      "id": "6d2f2e7d-cd2f-4b73-a7b1-6cf9fe0f406c",
      "name": "When chat message received",
      "webhookId": "1e8ffaf6-4809-4cf3-b5bf-c79edc5599e8"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -432,
        -160
      ],
      "id": "2f45e2f1-3469-46a7-bb09-83f5b6ba2cb1",
      "name": "Model"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.sessionId || $json.userId || $json.chatId || $json.$chatId || $json.$userId || $json.message?.chat?.id }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -432,
        160
      ],
      "id": "a3b73af5-81fd-4f9a-ba1a-569a2112b4cc",
      "name": "Memory"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "# Entra Onboarding Agent (SSO Pattern Selector)\n\nYou are an expert assistant that interviews application owners and selects the correct **Microsoft Entra ID** SSO pattern, then prepares an onboarding YAML and opens a GitHub PR.\n\n## Your tools\n- **Questionnaire JSON** — fetches the canonical question list.\n- **State: Get** — read conversation state for this user/app.\n- **State: Save** — persist each answer you collect, and the computed recommendation.\n- **Finalize Onboarding** — when you have everything, send a single JSON payload to this tool to create the YAML and the GitHub PR. It returns the PR URL.\n\n## Conversation protocol\n1. Start by asking for **application_id** and application name.\n2. Then, ask only one focused question at a time. After each answer, call **State: Save** with fields: `user_id`, `app_id`, `question_id`, `answer`.\n3. Use **Questionnaire JSON** at the start to know the available questions. Use them as your guidance, but feel free to ask follow-ups to clarify technical fit.\n4. Periodically use **State: Get** with `user_id` to reload your current progress (idempotent).\n5. When ready, compute a recommendation and confirm with the user.\n\n## Decision rules (abbreviated)\n- If application supports **OpenID Connect/OAuth 2.0**, prefer OIDC (Authorization Code, PKCE for public clients). \n- If not OIDC but supports **SAML 2.0**, choose SAML 2.0 (SP-initiated by default).\n- For legacy **WS-Fed**, use only if explicitly required.\n- For on-prem apps that need inbound access, use **Azure AD Application Proxy**. If app expects **headers or Kerberos**, use App Proxy with **KCD**.\n- For SPAs: OIDC with **PKCE**, implicit is not allowed.\n- Always capture: redirect/reply/logout URLs, claims needed, certificate requirements (SAML), and environment (dev/test/prod).\n\n## Final payload contract\nWhen you and the user confirm, call **Finalize Onboarding** with a JSON body:\n{\n  \"complete\": true,\n  \"user_id\": \"<user>\",\n  \"app_id\": \"<app-id>\",\n  \"application_name\": \"<name>\",\n  \"sso\": {\n    \"protocol\": \"oidc|saml|wsfed\",\n    \"flow\": \"authorization_code|pkce|n/a\",\n    \"proxy\": {\"use_app_proxy\": true|false, \"kcd\": true|false},\n    \"redirect_urls\": [\"...\"],\n    \"reply_urls\": [\"...\"],\n    \"logout_urls\": [\"...\"],\n    \"claims\": [\"email\",\"name\", \"...\"],\n    \"saml\": {\"metadata_url\": \"\", \"certificate\": \"\"}\n  },\n  \"contacts\": {\"custodian_name\": \"\", \"architect_name\": \"\"},\n  \"environment\": \"dev|test|prod\",\n  \"justification_text\": \"<why this pattern fits>\",\n  \"extras\": {}\n}\n\nAlso include **all raw Q&A** you collected as `answers: [{question_id, answer}]`.\n\n### Output style\n- Write concise, friendly messages.\n- After each question, wait for user reply.\n- Do not invent values.\n- If a tool call fails, try again or explain what you need.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -192,
        0
      ],
      "id": "3e1a8189-3bc6-4d7e-89df-ce03f44b735a",
      "name": "Entra Onboarding Agent"
    },
    {
      "parameters": {
        "toolDescription": "Fetches the official questionnaire JSON that drives the conversation.",
        "url": "https://raw.githubusercontent.com/GoyaAcademy/Entra-ID-Onboarding-Automation/main/questionnaires/questionnaire-sso-initiation-entra.json",
        "options": {
          "responseType": "json"
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        96,
        -256
      ],
      "id": "0a4edc18-c892-4ca7-9a2d-c0da384efffc",
      "name": "Questionnaire JSON"
    },
    {
      "parameters": {
        "toolDescription": "Get current conversation state for a user/app via PostgREST",
        "url": "http://postgrest:3000/conversation_state",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "user_id",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('user_id', ``, 'string') }}"
            },
            {
              "name": "select",
              "value": "=*"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        96,
        -80
      ],
      "id": "f1aa7c7d-02a3-4d98-b92f-800de5d7c1fa",
      "name": "State: Get"
    },
    {
      "parameters": {
        "toolDescription": "Upsert an answer and update state via PostgREST RPC save_answer(user_id, app_id, question_id, answer)",
        "method": "POST",
        "url": "http://postgrest:3000/rpc/save_answer",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('json', `{}`, 'json') }}",
        "options": {
          "responseType": "json"
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        96,
        96
      ],
      "id": "c8a9b7d2-78d2-4082-b3bf-3ef63fe98ba7",
      "name": "State: Save"
    },
    {
      "parameters": {
        "toolDescription": "Finalize the onboarding by creating YAML and PR. POST JSON payload as per contract.",
        "method": "POST",
        "url": "http://n8n:5678/webhook/entra-onboard-finalize",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('json', `{}`, 'json') }}",
        "options": {
          "responseType": "json"
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        96,
        272
      ],
      "id": "2b65f17d-d6a5-4dcf-9b58-9fc1523ab578",
      "name": "Finalize Onboarding"
    }
  ],
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "Entra Onboarding Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Model": {
      "ai_languageModel": [
        [
          {
            "node": "Entra Onboarding Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Memory": {
      "ai_memory": [
        [
          {
            "node": "Entra Onboarding Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Questionnaire JSON": {
      "ai_tool": [
        [
          {
            "node": "Entra Onboarding Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "State: Get": {
      "ai_tool": [
        [
          {
            "node": "Entra Onboarding Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "State: Save": {
      "ai_tool": [
        [
          {
            "node": "Entra Onboarding Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Finalize Onboarding": {
      "ai_tool": [
        [
          {
            "node": "Entra Onboarding Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "a8c4b396-ff99-4cab-88fb-3aab5251f46e",
  "meta": {
    "templateId": "entra_onboarding_agent_chat"
  },
  "id": "3fc27b49-4182-4b62-8ce2-8d300f6d944a",
  "tags": []
}
